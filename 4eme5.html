<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Classe - Fiches de Suivi</title>
  
  
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        .user-info {
            position: absolute;
            top: 10px;
            right: 30px;
            font-size: 0.85em;
            opacity: 0.9;
        }

        .logout-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            font-size: 0.9em;
            transition: all 0.3s;
            margin-left: 10px;
        }

        .logout-btn:hover {
            background: white;
            color: #667eea;
        }

        .header-left h1 {
            font-size: 2em;
            margin-bottom: 5px;
        }

        .back-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 2px solid white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
            text-decoration: none;
            transition: all 0.3s;
        }

        .back-btn:hover {
            background: white;
            color: #667eea;
        }

        .view-selector {
            display: none;
        }

        .view-selector.active {
            display: block;
        }

        .students-list-view {
            padding: 40px;
        }

        .action-bar {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
        }

        .action-bar button {
            flex: 1;
        }

        .students-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .student-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 25px;
            cursor: pointer;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        .student-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.3);
            border-color: #667eea;
        }

        .student-icon {
            font-size: 3em;
            text-align: center;
            margin-bottom: 15px;
        }

        .student-name {
            font-size: 1.3em;
            font-weight: bold;
            text-align: center;
            color: #333;
            margin-bottom: 10px;
        }

        .delete-student-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            font-size: 12px;
            cursor: pointer;
            margin-top: 10px;
            width: 100%;
        }

        .student-tracking-view {
            padding: 30px;
        }

        .schedule-grid {
            display: grid;
            grid-template-columns: 100px repeat(5, 1fr);
            gap: 2px;
            background: #ddd;
            border: 2px solid #ddd;
            margin-top: 20px;
        }

        .grid-cell {
            background: white;
            padding: 12px;
            min-height: 120px;
        }

        .grid-header {
            background: #667eea;
            color: white;
            font-weight: bold;
            text-align: center;
            padding: 12px;
        }

        .time-slot {
            background: #f8f9fa;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.85em;
        }

        .subject-cell {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }

        .subject-name {
            font-weight: bold;
            text-align: center;
            padding: 4px;
            border-radius: 5px;
            color: white;
            margin-bottom: 3px;
            font-size: 0.8em;
        }

        .tracking-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 9px;
            padding: 1px 0;
        }

        .tracking-buttons {
            display: flex;
            gap: 2px;
        }

        .track-btn {
            width: 28px;
            height: 28px;
            border: 2px solid #ddd;
            border-radius: 4px;
            background: white;
            cursor: pointer;
            font-weight: bold;
            padding: 0;
            transition: all 0.2s;
            font-size: 9px;
        }

        .track-btn:hover {
            transform: scale(1.1);
        }

        .track-btn.positive {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }

        .track-btn.negative {
            background: #dc3545;
            color: white;
            border-color: #dc3545;
        }

        .total-row {
            background: #e9ecef;
            font-weight: bold;
            font-size: 10px;
        }

        .week-navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .week-info {
            text-align: center;
        }

        .week-type {
            font-size: 1.5em;
            font-weight: bold;
            padding: 10px 20px;
            border-radius: 10px;
            display: inline-block;
            margin-bottom: 5px;
        }

        .week-type.semaine-a {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .week-type.semaine-b {
            background: #fff3e0;
            color: #e65100;
        }

        .week-dates {
            font-size: 0.95em;
            color: #666;
        }

        .nav-btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        .stats-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 12px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .stat-card {
            background: white;
            padding: 12px;
            border-radius: 8px;
            text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        .stat-card h3 {
            color: #667eea;
            margin-bottom: 8px;
            font-size: 0.85em;
        }

        .stat-value {
            font-size: 1.6em;
            font-weight: bold;
        }

        .empty-cell {
            background: #f8f9fa;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 700px;
            width: 90%;
            max-height: 85vh;
            overflow-y: auto;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-header h2 {
            color: #667eea;
        }

        .close-modal {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
        }

        .form-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #333;
        }

        input, select {
            width: 100%;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }

        input:focus, select:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            transition: transform 0.2s;
        }

        button:hover {
            transform: translateY(-2px);
        }

        .subject-colors {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-top: 10px;
        }

        .color-option {
            padding: 10px;
            border-radius: 5px;
            color: white;
            text-align: center;
            cursor: pointer;
            border: 3px solid transparent;
        }

        .color-option.selected {
            border-color: #333;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            flex: 1;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            flex: 1;
            border: none;
            padding: 12px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: bold;
        }

        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: #999;
        }

        .empty-state-icon {
            font-size: 5em;
            margin-bottom: 20px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
            font-size: 1.2em;
        }

        .items-list {
            margin-top: 20px;
        }

        .item-row {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .item-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .item-emoji {
            font-size: 1.5em;
        }

        .item-details {
            display: flex;
            flex-direction: column;
        }

        .item-name {
            font-weight: bold;
            color: #333;
        }

        .item-type {
            font-size: 0.85em;
            color: #666;
        }

        .btn-delete-item {
            background: #dc3545;
            color: white;
            border: none;
            padding: 5px 10px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 12px;
        }

        .notation-type-selector {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }

        .notation-option {
            flex: 1;
            padding: 12px;
            border: 2px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
        }

        .notation-option.selected {
            border-color: #667eea;
            background: #e3f2fd;
        }

        .info-banner {
            background: #fff3cd;
            border-left: 4px solid #ffc107;
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 20px;
        }

        .section-divider {
            border-top: 2px solid #e0e0e0;
            margin: 25px 0;
            padding-top: 20px;
        }

        .emoji-picker {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
            margin-top: 10px;
            max-height: 200px;
            overflow-y: auto;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }

        .emoji-option {
            font-size: 1.8em;
            cursor: pointer;
            text-align: center;
            padding: 8px;
            border-radius: 5px;
            transition: all 0.2s;
        }

        .emoji-option:hover {
            background: #667eea;
            transform: scale(1.2);
        }

        .week-selector {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .week-option {
            flex: 1;
            padding: 15px;
            border: 3px solid #ddd;
            border-radius: 10px;
            cursor: pointer;
            text-align: center;
            transition: all 0.3s;
            font-weight: bold;
            font-size: 1.1em;
        }

        .week-option.semaine-a {
            background: #e8f5e9;
            color: #2e7d32;
        }

        .week-option.semaine-b {
            background: #fff3e0;
            color: #e65100;
        }

        .week-option.selected {
            border-color: #333;
            transform: scale(1.05);
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <h1 id="className">Nom de la classe</h1>
                <p id="studentCount">Chargement...</p>
            </div>
            <div style="display: flex; align-items: center; gap: 10px;">
                <span class="user-info" id="userInfo">üë§ Chargement...</span>
                <button class="logout-btn" onclick="logout()">üö™ D√©connexion</button>
                <a href="fichedesuivi.html" class="back-btn">‚Üê Retour</a>
            </div>
        </div>

        <!-- Vue liste √©l√®ves -->
        <div class="view-selector active" id="studentsListView">
            <div class="students-list-view">
                <div id="studentsContent">
                    <div class="action-bar">
                        <button class="btn-primary" onclick="openClassItemsModal()">‚öôÔ∏è Items par d√©faut</button>
                        <button class="btn-primary" onclick="openAddStudentModal()">‚ûï Ajouter un √©l√®ve</button>
                    </div>
                    <h2 style="margin-bottom: 20px; color: #333;">üë• Liste des √©l√®ves</h2>
                    <div class="students-grid" id="studentsGrid"></div>
                </div>
            </div>
        </div>

        <!-- Vue fiche individuelle -->
        <div class="view-selector" id="studentTrackingView">
            <div class="student-tracking-view">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 id="currentStudentName" style="color: #667eea;"></h2>
                    <button class="btn-secondary" onclick="backToStudentsList()">‚Üê Retour</button>
                </div>

                <div class="week-navigation">
                    <button class="nav-btn" onclick="previousWeek()">‚Üê</button>
                    <div class="week-info">
                        <div class="week-type" id="weekType">Semaine A</div>
                        <div class="week-dates" id="weekDates">du 18/12 au 22/12/2025</div>
                    </div>
                    <button class="nav-btn" onclick="nextWeek()">‚Üí</button>
                </div>

                <div class="stats-summary" id="weekStats"></div>
                <div class="schedule-grid" id="scheduleGrid"></div>

               <!-- ‚úÖ METTRE CECI DANS LE HTML -->
                <div class="action-buttons" id="actionButtons"></div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div class="modal" id="addStudentModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Ajouter un √©l√®ve</h2>
                <button class="close-modal" onclick="closeModal('addStudentModal')">‚úï</button>
            </div>
            <div class="form-group">
                <label>Nom de l'√©l√®ve :</label>
                <input type="text" id="newStudentName" placeholder="Pr√©nom Nom">
            </div>
            <button class="btn-primary" onclick="addStudent()">Ajouter</button>
        </div>
    </div>

    <div class="modal" id="classItemsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Items par d√©faut</h2>
                <button class="close-modal" onclick="closeModal('classItemsModal')">‚úï</button>
            </div>
            <div class="info-banner"><strong>‚ÑπÔ∏è</strong> Ces items s'appliquent √† tous les √©l√®ves.</div>
            <div class="items-list" id="classItemsList"></div>
            <div class="section-divider"><h3 style="color: #667eea;">‚ûï Nouvel item</h3></div>
            <div class="form-group">
                <label>Nom :</label>
                <input type="text" id="newClassItemName" placeholder="Ex: Bavardages">
            </div>
            <div class="form-group">
                <label>Emoji :</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <span id="selectedClassEmoji" style="font-size: 2em;">üòä</span>
                    <button type="button" class="btn-secondary" style="width: auto; padding: 8px 15px;" onclick="toggleEmojiPicker('class')">Choisir</button>
                </div>
                <div class="emoji-picker" id="classEmojiPicker" style="display: none;">
                    <div class="emoji-option" onclick="selectEmoji('üòä','class')">üòä</div>
                    <div class="emoji-option" onclick="selectEmoji('üìö','class')">üìö</div>
                    <div class="emoji-option" onclick="selectEmoji('üöª','class')">üöª</div>
                    <div class="emoji-option" onclick="selectEmoji('üó£Ô∏è','class')">üó£Ô∏è</div>
                    <div class="emoji-option" onclick="selectEmoji('‚úã','class')">‚úã</div>
                    <div class="emoji-option" onclick="selectEmoji('üìù','class')">üìù</div>
                    <div class="emoji-option" onclick="selectEmoji('‚ö°','class')">‚ö°</div>
                    <div class="emoji-option" onclick="selectEmoji('üí™','class')">üí™</div>
                    <div class="emoji-option" onclick="selectEmoji('üéØ','class')">üéØ</div>
                    <div class="emoji-option" onclick="selectEmoji('‚è∞','class')">‚è∞</div>
                    <div class="emoji-option" onclick="selectEmoji('üëä','class')">üëä</div>
                    <div class="emoji-option" onclick="selectEmoji('üò§','class')">üò§</div>
                </div>
            </div>
            <div class="form-group">
                <label>Type :</label>
                <div class="notation-type-selector">
                    <div class="notation-option selected" data-type="both" onclick="selectNotationType(this,'class')">
                        <div>-1 et +1</div>
                    </div>
                    <div class="notation-option" data-type="negative" onclick="selectNotationType(this,'class')">
                        <div>-1 seul</div>
                    </div>
                    <div class="notation-option" data-type="positive" onclick="selectNotationType(this,'class')">
                        <div>+1 seul</div>
                    </div>
                </div>
            </div>
            <button class="btn-primary" onclick="addClassItem()">Ajouter</button>
        </div>
    </div>

    <div class="modal" id="studentItemsModal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Items sp√©cifiques</h2>
                <button class="close-modal" onclick="closeModal('studentItemsModal')">‚úï</button>
            </div>
            <div class="info-banner"><strong>‚ÑπÔ∏è</strong> Items uniquement pour cet √©l√®ve.</div>
            <div class="items-list" id="studentItemsList"></div>
            <div class="section-divider"><h3 style="color: #667eea;">‚ûï Nouvel item</h3></div>
            <div class="form-group">
                <label>Nom :</label>
                <input type="text" id="newStudentItemName" placeholder="Ex: Violence">
            </div>
            <div class="form-group">
                <label>Emoji :</label>
                <div style="display: flex; gap: 10px; align-items: center;">
                    <span id="selectedStudentEmoji" style="font-size: 2em;">üòä</span>
                    <button type="button" class="btn-secondary" style="width: auto; padding: 8px 15px;" onclick="toggleEmojiPicker('student')">Choisir</button>
                </div>
                <div class="emoji-picker" id="studentEmojiPicker" style="display: none;">
                    <div class="emoji-option" onclick="selectEmoji('üòä','student')">üòä</div>
                    <div class="emoji-option" onclick="selectEmoji('üìö','student')">üìö</div>
                    <div class="emoji-option" onclick="selectEmoji('üöª','student')">üöª</div>
                    <div class="emoji-option" onclick="selectEmoji('üó£Ô∏è','student')">üó£Ô∏è</div>
                    <div class="emoji-option" onclick="selectEmoji('‚úã','student')">‚úã</div>
                    <div class="emoji-option" onclick="selectEmoji('üìù','student')">üìù</div>
                    <div class="emoji-option" onclick="selectEmoji('‚ö°','student')">‚ö°</div>
                    <div class="emoji-option" onclick="selectEmoji('üí™','student')">üí™</div>
                    <div class="emoji-option" onclick="selectEmoji('üéØ','student')">üéØ</div>
                    <div class="emoji-option" onclick="selectEmoji('‚è∞','student')">‚è∞</div>
                    <div class="emoji-option" onclick="selectEmoji('üëä','student')">üëä</div>
                    <div class="emoji-option" onclick="selectEmoji('üò§','student')">üò§</div>
                </div>
            </div>
            <div class="form-group">
                <label>Type :</label>
                <div class="notation-type-selector">
                    <div class="notation-option selected" data-type="both" onclick="selectNotationType(this,'student')">
                        <div>-1 et +1</div>
                    </div>
                    <div class="notation-option" data-type="negative" onclick="selectNotationType(this,'student')">
                        <div>-1 seul</div>
                    </div>
                    <div class="notation-option" data-type="positive" onclick="selectNotationType(this,'student')">
                        <div>+1 seul</div>
                    </div>
                </div>
            </div>
            <button class="btn-primary" onclick="addStudentItem()">Ajouter</button>
        </div>
    </div>

    <div class="modal" id="scheduleModal">
    <div class="modal-content">
        <h2>üìÖ Ajouter une mati√®re</h2>
        
        <!-- S√©lection semaine -->
        <div class="week-selector">
            <div class="week-option selected" data-week="A" onclick="selectScheduleWeek(this)">Semaine A</div>
            <div class="week-option" data-week="B" onclick="selectScheduleWeek(this)">Semaine B</div>
        </div>
        
        <!-- S√©lection jour -->
        <label>Jour :</label>
        <select id="daySelect">
            <option value="Lundi">Lundi</option>
            <option value="Mardi">Mardi</option>
            <option value="Mercredi">Mercredi</option>
            <option value="Jeudi">Jeudi</option>
            <option value="Vendredi">Vendredi</option>
        </select>
        
        <!-- S√©lection cr√©neau -->
        <label>Cr√©neau :</label>
        <select id="slotSelect">
            <option value="M1">M1 (8h30-9h25)</option>
            <option value="M2">M2 (9h30-10h25)</option>
            <option value="M3">M3 (10h40-11h35)</option>
            <option value="M4">M4 (11h40-12h35)</option>
            <option value="S0">S0 (12h55-13h50)</option>
            <option value="S1">S1 (13h55-14h50)</option>
            <option value="S2">S2 (15h05-16h00)</option>
            <option value="S3">S3 (16h05-17h00)</option>
        </select>
        
        <!-- ‚úÖ NOUVEAU : Liste d√©roulante de mati√®res -->
        <label>Mati√®re :</label>
        <select id="subjectSelect" onchange="handleSubjectChange()">
            <option value="">-- Choisir une mati√®re --</option>
            <option value="Math√©matiques">üìê Math√©matiques</option>
            <option value="Fran√ßais">üìö Fran√ßais</option>
            <option value="Histoire-G√©o">üåç Histoire-G√©o</option>
            <option value="Anglais">üá¨üáß Anglais</option>
            <option value="Espagnol">üá™üá∏ Espagnol</option>
            <option value="Allemand">üá©üá™ Allemand</option>
            <option value="SVT">üß¨ SVT</option>
            <option value="Physique-Chimie">‚öóÔ∏è Physique-Chimie</option>
            <option value="Technologie">üîß Technologie</option>
            <option value="EPS">‚öΩ EPS</option>
            <option value="Arts Plastiques">üé® Arts Plastiques</option>
            <option value="Musique">üéµ Musique</option>
            <option value="Vie de classe">üë• Vie de classe</option>
            <option value="Permanence">üìñ Permanence</option>
            <option value="Autre">‚úèÔ∏è Autre (personnalis√©)</option>
        </select>
        
        <!-- ‚úÖ NOUVEAU : Champ personnalis√© (masqu√© par d√©faut) -->
        <div id="customSubjectDiv" style="display: none;">
            <label>Nom personnalis√© :</label>
            <input type="text" id="customSubjectInput" placeholder="Ex: Accompagnement personnalis√©">
        </div>
        
        <!-- S√©lection couleur (automatique maintenant) -->
        <label>Couleur : <span id="colorPreview" style="display: inline-block; width: 20px; height: 20px; border-radius: 3px; margin-left: 10px;"></span></label>
        <div class="color-picker" id="colorPickerSchedule">
            <div class="color-option" data-color="#3498db" style="background: #3498db;"></div>
            <div class="color-option" data-color="#e74c3c" style="background: #e74c3c;"></div>
            <div class="color-option" data-color="#f39c12" style="background: #f39c12;"></div>
            <div class="color-option" data-color="#9b59b6" style="background: #9b59b6;"></div>
            <div class="color-option" data-color="#27ae60" style="background: #27ae60;"></div>
            <div class="color-option" data-color="#16a085" style="background: #16a085;"></div>
            <div class="color-option" data-color="#34495e" style="background: #34495e;"></div>
            <div class="color-option" data-color="#95a5a6" style="background: #95a5a6;"></div>
        </div>
        
        <div style="display: flex; gap: 10px; margin-top: 20px;">
            <button class="btn-primary" onclick="addSubjectToSchedule()">Ajouter</button>
            <button class="btn-secondary" onclick="closeModal('scheduleModal')">Annuler</button>
        </div>
    </div>
</div>

    <script type="module">
         // Imports Firebase
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-auth.js";
        import { getFirestore, collection, getDocs, addDoc, updateDoc, doc, deleteDoc, getDoc, setDoc } from "https://www.gstatic.com/firebasejs/11.0.2/firebase-firestore.js";

        
        // ‚ö†Ô∏è CONFIGURATION FIREBASE - √Ä MODIFIER
        const firebaseConfig = {
          apiKey: "AIzaSyA4BpxaadwjKgiJH3rwOdk3WaJ9m5G9qqw",
          authDomain: "suivi-classe-4eme.firebaseapp.com",
          databaseURL: "https://suivi-classe-4eme-default-rtdb.europe-west1.firebasedatabase.app",
          projectId: "suivi-classe-4eme",
          storageBucket: "suivi-classe-4eme.firebasestorage.app",
          messagingSenderId: "1088897454236",
          appId: "1:1088897454236:web:9d2f1f5e25532e93605d59"
};
        // ‚úÖ AJOUTER CES LIGNES ICI
        const OWNER_EMAIL = 'collegejeanjaures.sdurand@gmail.com';
        const ADMIN_EMAILS = ['collegejeanjaures.sdurand@gmail.com'];

       // Initialisation Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

     
        // ‚ö†Ô∏è IDENTIFIANT CLASSE - √Ä MODIFIER
        const CLASS_ID = "4eme5";
        const CLASS_NAME = "4√®me 5";
        
        // ‚ö†Ô∏è DATE D√âBUT ANN√âE SCOLAIRE - √Ä MODIFIER
        // Format: "YYYY-MM-DD" - Premier jour de la rentr√©e
        const SCHOOL_YEAR_START = "2025-09-01"; // Exemple: 2 septembre 2025
    
        // ========================================
        // V√âRIFICATION AUTHENTIFICATION
        // ========================================
// ‚úÖ UN SEUL onAuthStateChanged
auth.onAuthStateChanged((user) => {
    if (!user) {
        window.location.href = 'login.html';
    } else {
        currentUserEmail = user.email;
        
        // V√©rifications admin/owner
        isOwner = OWNER_EMAIL === currentUserEmail;
        isAdmin = ADMIN_EMAILS.includes(currentUserEmail);
        
        console.log('currentUserEmail:', currentUserEmail);
        console.log('isOwner:', isOwner);
        console.log('isAdmin:', isAdmin);
        
        document.getElementById('userInfo').textContent = `üë§ ${user.email}`;
        
        updateActionButtons();  // ‚úÖ Mise √† jour des boutons
        
        loadStudents();
    }
});

// ‚úÖ Fonction pour afficher/cacher les boutons admin
function updateActionButtons() {
    const actionButtonsDiv = document.getElementById('actionButtons');
    
    if (isOwner || isAdmin) {
        actionButtonsDiv.innerHTML = `
            <button class="btn-secondary" onclick="openScheduleModal()">üìÖ Emploi du temps</button>
            <button class="btn-secondary" onclick="openStudentItemsModal()">‚öôÔ∏è Items sp√©cifiques</button>
        `;
    } else {
        actionButtonsDiv.innerHTML = '';
    }
}
        
        // Fonction de d√©connexion
        async function logout() {
            if (confirm('Voulez-vous vraiment vous d√©connecter ?')) {
                try {
                    await auth.signOut();
                    window.location.href = 'login.html';
                } catch (error) {
                    console.error('Erreur de d√©connexion:', error);
                    alert('Erreur lors de la d√©connexion');
                }
            }
        }

        let students = [];
        let classItems = [];
        let currentStudentId = null;
        let currentWeek = 0;
        let selectedColor = '#3498db';
        let selectedClassEmoji = 'üòä';
        let selectedStudentEmoji = 'üòä';
        let selectedClassNotationType = 'both';
        let selectedStudentNotationType = 'both';
        let selectedScheduleWeek = 'A';
        let currentUserEmail = '';
        let isOwner = false;
        let isAdmin = false;

        const days = ['Lundi', 'Mardi', 'Mercredi', 'Jeudi', 'Vendredi'];
        const slots = ['M1', 'M2', 'M3', 'M4', 'S0', 'S1', 'S2', 'S3'];
        const slotLabels = {
            'M1': '8h30-9h25', 'M2': '9h30-10h25', 'M3': '10h40-11h35', 'M4': '11h40-12h35',
            'S0': '12h55-13h50', 'S1': '13h55-14h50', 'S2': '15h05-16h00', 'S3': '16h05-17h00'
        };

        // ‚úÖ AJOUTER CES MATI√àRES PR√âD√âFINIES
        const predefinedSubjects = {
        'Math√©matiques': '#3498db',
        'Fran√ßais': '#e74c3c',
        'Histoire-G√©o': '#f39c12',
        'Anglais': '#9b59b6',
        'Espagnol': '#e67e22',
        'Allemand': '#1abc9c',
        'SVT': '#27ae60',
        'Physique-Chimie': '#16a085',
        'Technologie': '#34495e',
        'EPS': '#2ecc71',
        'Arts Plastiques': '#ff6b9d',
        'Musique': '#8e44ad',
        'Vie de classe': '#95a5a6',
        'Permanence': '#bdc3c7',
        'Autre': '#7f8c8d'
};
        // Calcul semaine A/B
        function getWeekType(weekOffset = 0) {
            const startDate = new Date(SCHOOL_YEAR_START);
            const targetDate = new Date();
            targetDate.setDate(targetDate.getDate() + (weekOffset * 7));
            
            const diffTime = Math.abs(targetDate - startDate);
            const diffWeeks = Math.floor(diffTime / (1000 * 60 * 60 * 24 * 7));
            
            return diffWeeks % 2 === 0 ? 'A' : 'B';
        }

        function getWeekDateRange() {
            const today = new Date();
            const weekStart = new Date(today);
            weekStart.setDate(today.getDate() + (currentWeek * 7));
            weekStart.setDate(weekStart.getDate() - weekStart.getDay() + 1);
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekStart.getDate() + 4);

            const fmt = (d) => `${d.getDate().toString().padStart(2,'0')}/${(d.getMonth()+1).toString().padStart(2,'0')}/${d.getFullYear()}`;
            return `du ${fmt(weekStart)} au ${fmt(weekEnd)}`;
        }

        function getWeekKey() {
            return `week_${currentWeek}_${getWeekType(currentWeek)}`;
        }

        document.querySelectorAll('.color-option').forEach(opt => {
            opt.addEventListener('click', function() {
                document.querySelectorAll('.color-option').forEach(o => o.classList.remove('selected'));
                this.classList.add('selected');
                selectedColor = this.dataset.color;
            });
        });

        function toggleEmojiPicker(type) {
            const picker = document.getElementById(type + 'EmojiPicker');
            picker.style.display = picker.style.display === 'none' ? 'grid' : 'none';
        }

        function selectEmoji(emoji, type) {
            if (type === 'class') {
                selectedClassEmoji = emoji;
                document.getElementById('selectedClassEmoji').textContent = emoji;
            } else {
                selectedStudentEmoji = emoji;
                document.getElementById('selectedStudentEmoji').textContent = emoji;
            }
            document.getElementById(type + 'EmojiPicker').style.display = 'none';
        }

        function selectNotationType(el, type) {
            el.parentElement.querySelectorAll('.notation-option').forEach(o => o.classList.remove('selected'));
            el.classList.add('selected');
            if (type === 'class') selectedClassNotationType = el.dataset.type;
            else selectedStudentNotationType = el.dataset.type;
        }

        function selectScheduleWeek(el) {
            el.parentElement.querySelectorAll('.week-option').forEach(o => o.classList.remove('selected'));
            el.classList.add('selected');
            selectedScheduleWeek = el.dataset.week;
        }

       
       async function loadStudents() {
    try {
        // ‚úÖ Charger les √©l√®ves
        const studentsRef = collection(db, 'classes', CLASS_ID, 'students');
        const querySnapshot = await getDocs(studentsRef);
        
        students = [];
        querySnapshot.forEach((doc) => {
            students.push({
                id: doc.id,
                ...doc.data()
            });
        }); 
                   
        // ‚úÖ Afficher le r√¥le (ce code √©tait orphelin)
        if (isAdmin && !isOwner) {
            document.getElementById('className').innerHTML = `${CLASS_NAME} <span style="background: #ff6b6b; color: white; padding: 3px 8px; border-radius: 5px; font-size: 0.7em;">üõ†Ô∏è Admin</span>`;
        } else if (isOwner) {
            document.getElementById('className').innerHTML = `${CLASS_NAME} <span style="background: #ffd700; color: #333; padding: 3px 8px; border-radius: 5px; font-size: 0.7em;">üëë Propri√©taire</span>`;
        } else {
            document.getElementById('className').innerHTML = `${CLASS_NAME} <span style="background: #4caf50; color: white; padding: 3px 8px; border-radius: 5px; font-size: 0.7em;">ü§ù Collaborateur</span>`;
        }
        
        // ‚úÖ Masquer les boutons si collaborateur
        if (!isOwner && !isAdmin) {
            hideOwnerOnlyButtons();
        }
        
        // ‚úÖ Afficher la liste
        renderStudentsList();
        
    } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur lors du chargement des √©l√®ves');
    }
}

        function hideOwnerOnlyButtons() {
            // Masquer les boutons r√©serv√©s au propri√©taire
            const ownerButtons = document.querySelectorAll('.btn-primary');
            ownerButtons.forEach(btn => {
                if (btn.textContent.includes('Items par d√©faut') || 
                    btn.textContent.includes('Ajouter un √©l√®ve')) {
                    btn.style.display = 'none';
                }
            });
        }

        async function saveClassData() {
    try {
        const classRef = doc(db, 'classes', CLASS_ID);
        await updateDoc(classRef, {
            students: students,
            classItems: classItems,
            className: CLASS_NAME,
            updatedAt: new Date()
        });
    } catch (error) {
        console.error('Erreur:', error);
        alert('Erreur de sauvegarde');
    }
}

        function openClassItemsModal() {
            if (!isOwner && !isAdmin) {
                alert('Seul le propri√©taire ou un administrateur peut modifier les items par d√©faut.');
                return;
            }
            renderClassItemsList();
            document.getElementById('classItemsModal').classList.add('active');
        }

        function renderClassItemsList() {
            const list = document.getElementById('classItemsList');
            if (classItems.length === 0) {
                list.innerHTML = '<p style="text-align:center;color:#999;padding:20px;">Aucun item</p>';
                return;
            }
            list.innerHTML = classItems.map((item, i) => `
                <div class="item-row">
                    <div class="item-info">
                        <div class="item-emoji">${item.emoji}</div>
                        <div class="item-details">
                            <div class="item-name">${item.name}</div>
                            <div class="item-type">${item.type === 'both' ? '‚àí1 et +1' : item.type === 'negative' ? '‚àí1 seul' : '+1 seul'}</div>
                        </div>
                    </div>
                    <button class="btn-delete-item" onclick="deleteClassItem(${i})">Suppr.</button>
                </div>
            `).join('');
        }

        async function addClassItem() {
            const name = document.getElementById('newClassItemName').value.trim();
            if (!name) return alert('Entrez un nom');
            classItems.push({
                id: 'item_' + Date.now(),
                name: name,
                emoji: selectedClassEmoji,
                type: selectedClassNotationType
            });
            await saveClassData();
            renderClassItemsList();
            document.getElementById('newClassItemName').value = '';
            alert('Item ajout√© !');
        }

        async function deleteClassItem(i) {
            if (confirm('Supprimer cet item ?')) {
                classItems.splice(i, 1);
                await saveClassData();
                renderClassItemsList();
            }
        }

        function openStudentItemsModal() {
            if (!isOwner && !isAdmin) {
                alert('Seul le propri√©taire ou un administrateur peut modifier les items sp√©cifiques.');
                return;
            }
            renderStudentItemsList();
            document.getElementById('studentItemsModal').classList.add('active');
        }

        function renderStudentItemsList() {
            const student = students.find(s => s.id === currentStudentId);
            const list = document.getElementById('studentItemsList');
            if (!student.specificItems || student.specificItems.length === 0) {
                list.innerHTML = '<p style="text-align:center;color:#999;padding:20px;">Aucun item sp√©cifique</p>';
                return;
            }
            list.innerHTML = student.specificItems.map((item, i) => `
                <div class="item-row">
                    <div class="item-info">
                        <div class="item-emoji">${item.emoji}</div>
                        <div class="item-details">
                            <div class="item-name">${item.name}</div>
                            <div class="item-type">${item.type === 'both' ? '‚àí1 et +1' : item.type === 'negative' ? '‚àí1 seul' : '+1 seul'}</div>
                        </div>
                    </div>
                    <button class="btn-delete-item" onclick="deleteStudentItem(${i})">Suppr.</button>
                </div>
            `).join('');
        }

        async function addStudentItem() {
            const name = document.getElementById('newStudentItemName').value.trim();
            if (!name) return alert('Entrez un nom');
            const student = students.find(s => s.id === currentStudentId);
            if (!student.specificItems) student.specificItems = [];
            student.specificItems.push({
                id: 'item_' + Date.now(),
                name: name,
                emoji: selectedStudentEmoji,
                type: selectedStudentNotationType
            });
            await saveClassData();
            renderStudentItemsList();
            renderSchedule();
            document.getElementById('newStudentItemName').value = '';
            alert('Item ajout√© !');
        }

        async function deleteStudentItem(i) {
            if (confirm('Supprimer ?')) {
                const student = students.find(s => s.id === currentStudentId);
                student.specificItems.splice(i, 1);
                await saveClassData();
                renderStudentItemsList();
                renderSchedule();
            }
        }

        function renderStudentsList() {
            const grid = document.getElementById('studentsGrid');
            document.getElementById('className').textContent = CLASS_NAME;
            document.getElementById('studentCount').textContent = `${students.length} √©l√®ve(s)`;
            if (students.length === 0) {
                grid.innerHTML = '<div class="empty-state" style="grid-column:1/-1;"><div class="empty-state-icon">üë®‚Äçüéì</div><h3>Aucun √©l√®ve</h3></div>';
                return;
            }
            grid.innerHTML = students.map(s => `
                <div class="student-card" onclick="openStudentTracking('${s.id}')">
                    <div class="student-icon">üë®‚Äçüéì</div>
                    <div class="student-name">${s.name}</div>
                    ${(isOwner || isAdmin) ? `<button class="delete-student-btn" onclick="event.stopPropagation();deleteStudent('${s.id}')">üóëÔ∏è Supprimer</button>` : ''}
                </div>
            `).join('');
        }

        function openAddStudentModal() {
            if (!isOwner && !isAdmin) {
                alert('Seul le propri√©taire ou un administrateur peut ajouter des √©l√®ves.');
                return;
            }
            document.getElementById('addStudentModal').classList.add('active');
        }

        async function addStudent() {
            const name = document.getElementById('newStudentName').value.trim();
            if (!name) return alert('Entrez un nom');
            students.push({
                id: 'student_' + Date.now(),
                name: name,
                scheduleA: {},
                scheduleB: {},
                specificItems: []
            });
            await saveClassData();
            renderStudentsList();
            closeModal('addStudentModal');
            document.getElementById('newStudentName').value = '';
        }
 function closeModal(id) {
            document.getElementById(id).classList.remove('active');
        }
            
        async function deleteStudent(id) {
    if (!isOwner && !isAdmin) {
        alert('Seul le propri√©taire ou un administrateur peut supprimer des √©l√®ves.');
        return;
    }
    const s = students.find(st => st.id === id);
    if (confirm(`Supprimer ${s.name} ?`)) {
        students = students.filter(st => st.id !== id);
        try {
            const trackingRef = doc(db, 'tracking', `${CLASS_ID}_${id}`);
            await deleteDoc(trackingRef);
        } catch (e) {}
        await saveClassData();
        renderStudentsList();
    }
}
        function openStudentTracking(id) {
            currentStudentId = id;
            const s = students.find(st => st.id === id);
            document.getElementById('currentStudentName').textContent = s.name;
            document.getElementById('studentsListView').classList.remove('active');
            document.getElementById('studentTrackingView').classList.add('active');
            renderSchedule();
        }

        function backToStudentsList() {
            currentStudentId = null;
            document.getElementById('studentTrackingView').classList.remove('active');
            document.getElementById('studentsListView').classList.add('active');
        }

        function openScheduleModal() {
            if (!isOwner && !isAdmin) {
                alert('Seul le propri√©taire ou un administrateur peut modifier l\'emploi du temps.');
                return;
            }
            document.getElementById('scheduleModal').classList.add('active');
        }

// ‚úÖ NOUVELLE FONCTION : G√©rer le changement de mati√®re
function handleSubjectChange() {
    const select = document.getElementById('subjectSelect');
    const customDiv = document.getElementById('customSubjectDiv');
    const colorPreview = document.getElementById('colorPreview');
    const selectedSubject = select.value;
    
    // Afficher/masquer le champ personnalis√©
    if (selectedSubject === 'Autre') {
        customDiv.style.display = 'block';
        selectedColor = '#7f8c8d'; // Couleur par d√©faut pour "Autre"
    } else {
        customDiv.style.display = 'none';
        // Appliquer la couleur pr√©d√©finie
        if (predefinedSubjects[selectedSubject]) {
            selectedColor = predefinedSubjects[selectedSubject];
        }
    }
    
    // Mettre √† jour l'aper√ßu de couleur
    colorPreview.style.background = selectedColor;
    
    // Mettre √† jour la s√©lection visuelle dans le color picker
    document.querySelectorAll('#colorPickerSchedule .color-option').forEach(opt => {
        opt.classList.remove('selected');
        if (opt.dataset.color === selectedColor) {
            opt.classList.add('selected');
        }
    });
}

// ‚úÖ MODIFIER addSubjectToSchedule()
async function addSubjectToSchedule() {
    const day = document.getElementById('daySelect').value;
    const slot = document.getElementById('slotSelect').value;
    const subjectSelect = document.getElementById('subjectSelect').value;
    
    // D√©terminer le nom de la mati√®re
    let subjectName;
    if (subjectSelect === 'Autre') {
        subjectName = document.getElementById('customSubjectInput').value.trim();
        if (!subjectName) return alert('Entrez un nom de mati√®re personnalis√©');
    } else if (subjectSelect === '') {
        return alert('Choisissez une mati√®re');
    } else {
        subjectName = subjectSelect;
    }
    
    const student = students.find(s => s.id === currentStudentId);
    const scheduleKey = selectedScheduleWeek === 'A' ? 'scheduleA' : 'scheduleB';
    if (!student[scheduleKey]) student[scheduleKey] = {};
    
    student[scheduleKey][`${day}-${slot}`] = {
        subject: subjectName,
        color: selectedColor
    };
    
    await saveClassData();
    renderSchedule();
    alert('Mati√®re ajout√©e !');
    
    // R√©initialiser le formulaire
    document.getElementById('subjectSelect').value = '';
    document.getElementById('customSubjectInput').value = '';
    document.getElementById('customSubjectDiv').style.display = 'none';
}
        
        async function addSubjectToSchedule() {
            const day = document.getElementById('daySelect').value;
            const slot = document.getElementById('slotSelect').value;
            const subject = document.getElementById('subjectInput').value.trim();
            if (!subject) return alert('Entrez une mati√®re');
            
            const student = students.find(s => s.id === currentStudentId);
            const scheduleKey = selectedScheduleWeek === 'A' ? 'scheduleA' : 'scheduleB';
            if (!student[scheduleKey]) student[scheduleKey] = {};
            
            student[scheduleKey][`${day}-${slot}`] = {
                subject: subject,
                color: selectedColor
            };
            
            await saveClassData();
            renderSchedule();
            alert('Mati√®re ajout√©e !');
            document.getElementById('subjectInput').value = '';
        }

        async function getTrackingData() {
    try {
        const trackingRef = doc(db, 'tracking', `${CLASS_ID}_${currentStudentId}`);
        const docSnap = await getDoc(trackingRef);
        return docSnap.exists() ? docSnap.data() : {};
    } catch (e) {
        return {};
    }
}

        async function saveTrackingData(data) {
    try {
        const trackingRef = doc(db, 'tracking', `${CLASS_ID}_${currentStudentId}`);
        await setDoc(trackingRef, {
            ...data,
            updatedAt: new Date()
        });
    } catch (e) {
        console.error('Erreur:', e);
    }
}

        function getAllItems() {
            const s = students.find(st => st.id === currentStudentId);
            return [...classItems, ...(s.specificItems || [])];
        }

        function renderSchedule() {
            const student = students.find(s => s.id === currentStudentId);
            if (!student) return;

            const weekType = getWeekType(currentWeek);
            const schedule = weekType === 'A' ? student.scheduleA : student.scheduleB;
            const allItems = getAllItems();
            
            document.getElementById('weekType').textContent = `Semaine ${weekType}`;
            document.getElementById('weekType').className = `week-type semaine-${weekType.toLowerCase()}`;
            document.getElementById('weekDates').textContent = getWeekDateRange();

            const grid = document.getElementById('scheduleGrid');
            grid.innerHTML = '<div class="grid-cell grid-header"></div>';
            days.forEach(d => grid.innerHTML += `<div class="grid-cell grid-header">${d}</div>`);

            slots.forEach(slot => {
                grid.innerHTML += `<div class="grid-cell time-slot">${slot}<br>${slotLabels[slot]}</div>`;
                days.forEach(day => {
                    const key = `${day}-${slot}`;
                    const subj = schedule[key];
                    if (subj) {
                        let html = `<div class="grid-cell subject-cell"><div class="subject-name" style="background:${subj.color};">${subj.subject}</div>`;
                        allItems.forEach(item => {
                            const btns = [];
                            if (item.type === 'both' || item.type === 'negative') 
                                btns.push(`<button class="track-btn" id="btn-${key}-${item.id}--1" onclick="toggleTracking('${key}','${item.id}',-1)">-1</button>`);
                            if (item.type === 'both' || item.type === 'positive') 
                                btns.push(`<button class="track-btn" id="btn-${key}-${item.id}-1" onclick="toggleTracking('${key}','${item.id}',1)">+1</button>`);
                            html += `<div class="tracking-row"><span>${item.emoji}</span><div class="tracking-buttons">${btns.join('')}</div></div>`;
                        });
                        grid.innerHTML += html + '</div>';
                    } else {
                        grid.innerHTML += '<div class="grid-cell empty-cell"></div>';
                    }
                });
            });

            grid.innerHTML += '<div class="grid-cell total-row grid-header">TOTAL</div>';
            days.forEach(d => grid.innerHTML += `<div class="grid-cell total-row" id="total-${d}"></div>`);

            updateButtonStates();
            renderWeekStats();
            updateDayTotals();
        }

        async function updateButtonStates() {
            const data = await getTrackingData();
            const weekKey = getWeekKey();
            const student = students.find(s => s.id === currentStudentId);
            const weekType = getWeekType(currentWeek);
            const schedule = weekType === 'A' ? student.scheduleA : student.scheduleB;
            const allItems = getAllItems();

            days.forEach(day => {
                slots.forEach(slot => {
                    const key = `${day}-${slot}`;
                    if (schedule[key]) {
                        allItems.forEach(item => {
                            const tk = `${weekKey}-${key}-${item.id}`;
                            const val = data[tk];
                            [-1, 1].forEach(bv => {
                                const btn = document.getElementById(`btn-${key}-${item.id}-${bv}`);
                                if (btn) {
                                    btn.classList.remove('positive', 'negative');
                                    if (val === bv) btn.classList.add(bv === 1 ? 'positive' : 'negative');
                                }
                            });
                        });
                    }
                });
            });
        }

        async function toggleTracking(key, itemId, val) {
            const data = await getTrackingData();
            const weekKey = getWeekKey();
            const tk = `${weekKey}-${key}-${itemId}`;
            if (data[tk] === val) delete data[tk];
            else data[tk] = val;
            await saveTrackingData(data);
            await updateButtonStates();
            await updateDayTotals();
            renderWeekStats();
        }

        async function updateDayTotals() {
            const allItems = getAllItems();
            const student = students.find(s => s.id === currentStudentId);
            const weekType = getWeekType(currentWeek);
            const schedule = weekType === 'A' ? student.scheduleA : student.scheduleB;
            const data = await getTrackingData();
            const weekKey = getWeekKey();

            days.forEach(day => {
                const tots = {};
                allItems.forEach(item => tots[item.id] = 0);
                slots.forEach(slot => {
                    const key = `${day}-${slot}`;
                    if (schedule[key]) {
                        allItems.forEach(item => {
                            tots[item.id] += data[`${weekKey}-${key}-${item.id}`] || 0;
                        });
                    }
                });
                const cell = document.getElementById(`total-${day}`);
                if (cell) {
                    cell.innerHTML = allItems.map(item => 
                        `<div style="margin:2px 0;font-size:10px;">${item.emoji}: <strong>${tots[item.id]}</strong></div>`
                    ).join('');
                }
            });
        }

        async function renderWeekStats() {
            const allItems = getAllItems();
            const student = students.find(s => s.id === currentStudentId);
            const weekType = getWeekType(currentWeek);
            const schedule = weekType === 'A' ? student.scheduleA : student.scheduleB;
            const data = await getTrackingData();
            const weekKey = getWeekKey();
            const tots = {};

            allItems.forEach(item => tots[item.id] = 0);
            days.forEach(day => {
                slots.forEach(slot => {
                    const key = `${day}-${slot}`;
                    if (schedule[key]) {
                        allItems.forEach(item => {
                            tots[item.id] += data[`${weekKey}-${key}-${item.id}`] || 0;
                        });
                    }
                });
            });

            document.getElementById('weekStats').innerHTML = allItems.map(item => `
                <div class="stat-card">
                    <h3>${item.emoji} ${item.name}</h3>
                    <div class="stat-value ${tots[item.id] >= 0 ? 'positive' : 'negative'}">
                        ${tots[item.id] > 0 ? '+' : ''}${tots[item.id]}
                    </div>
                </div>
            `).join('');
        }

        function previousWeek() {
            currentWeek--;
            renderSchedule();
        }

        function nextWeek() {
            currentWeek++;
            renderSchedule();
        }

        // ‚úÖ Rendre les fonctions accessibles depuis le HTML
window.openAddStudentModal = openAddStudentModal;
window.addStudent = addStudent;
window.closeModal = closeModal;
window.deleteStudent = deleteStudent;
window.openStudentTracking = openStudentTracking;
window.backToStudentsList = backToStudentsList;
window.logout = logout;
window.openClassItemsModal = openClassItemsModal;
window.addClassItem = addClassItem;
window.deleteClassItem = deleteClassItem;
window.openStudentItemsModal = openStudentItemsModal;
window.addStudentItem = addStudentItem;
window.deleteStudentItem = deleteStudentItem;
window.openScheduleModal = openScheduleModal;
window.addSubjectToSchedule = addSubjectToSchedule;
window.toggleTracking = toggleTracking;
window.previousWeek = previousWeek;
window.nextWeek = nextWeek;
window.toggleEmojiPicker = toggleEmojiPicker;
window.selectEmoji = selectEmoji;
window.selectNotationType = selectNotationType;
window.selectScheduleWeek = selectScheduleWeek;
window.handleSubjectChange = handleSubjectChange;

// Initialisation
        loadStudents();
    </script>
